
variables:
  PYTHON_BASE_IMAGE: deltafi/python:3.13.9-3
  JAVA_BASE_IMAGE: deltafi/deltafi-build:jdk21.0.9-python3.13.9-0
  GO_BASE_IMAGE: deltafi/deltafi-build:jdk21.0.9_10-golang1.25.4-alpine-0
  BUILDX_BASE_IMAGE: deltafi/docker-with-buildx:28.5.1-alpine3.22-0.29.1-0

  PROJECT_NAME: ${CI_PROJECT_NAME}
  CORE_PROJECT_ID: 45043636

  DOCKER_DRIVER: overlay2
  DOCKER_PLATFORMS: linux/amd64,linux/arm64/v8
  GITLAB_REPOSITORY: ${CI_REGISTRY_IMAGE}
  DOCKER_IO_NAMESPACE: docker.io/deltafi
  DOCKER_DEV_TAG: ${CI_COMMIT_SHORT_SHA}
  DOCKER_RELEASE_TAG: ${CI_COMMIT_TAG}

  FF_USE_FASTZIP: "true"
  TRANSFER_METER_FREQUENCY: "2s"
  ARTIFACT_COMPRESSION_LEVEL: "fastest"
  CACHE_COMPRESSION_LEVEL: "fastest"


default:
  timeout: 45m

image: ${JAVA_BASE_IMAGE}

.gradle:
  variables:
    GRADLE_USER_HOME: /cache/.gradle.${CI_CONCURRENT_ID}
    GRADLE_OPTS: "-Dorg.gradle.daemon=false"
    GRADLE: "./gradlew -s --parallel --no-daemon -PgitLabTokenType=Job-Token -PgitLabToken=${CI_JOB_TOKEN}"

.golang:
  image: ${GO_BASE_IMAGE}
  variables:
    GOPATH: /cache/go

.gradle-build:
  variables:
    GRADLE_TASKS: assemble test
  extends:
    - .gradle
  stage: build
  script:
    - ${GRADLE} --rerun-tasks ${GRADLE_TASKS}
  artifacts:
    when: always
    reports:
      junit: "**/build/test-results/test/**/TEST-*.xml"
    paths:
      - "**/build"
      - ".gradle"

.publish:
  tags:
    - heavy
  extends:
    - .gradle
  stage: publish
  needs:
    - job: "Core Build"

.docker-build:
  stage: docker
  image: ${BUILDX_BASE_IMAGE}
  services:
    - docker:stable-dind
  tags:
    - light
  variables:
    REGISTRY: ${CI_REGISTRY}
    REGISTRY_USERNAME: ${CI_REGISTRY_USER}
    REGISTRY_PASSWORD: ${CI_JOB_TOKEN}
    DOCKER_REPOSITORY: ${CI_REGISTRY_IMAGE}
    DOCKER_TAG: ${DOCKER_DEV_TAG}
    DOCKERFILE: "Dockerfile"
    CONTEXT: "."
    DOCKER_BUILD_FLAGS:
    PUSH: --push
  retry:
    max: 2
    when:
      - script_failure
  before_script:
    - docker buildx inspect
    - docker buildx create --name deltafi-inator --use
    - docker buildx inspect
    - docker login -u ${REGISTRY_USERNAME} -p ${REGISTRY_PASSWORD} ${REGISTRY}
    - docker login -u ${CI_REGISTRY_USER} -p ${CI_JOB_TOKEN} ${CI_REGISTRY}
  script:
    - >
      echo docker buildx build ${PUSH}
      --cache-to=type=registry,ref=${CI_REGISTRY_IMAGE}/${PROJECT_NAME}:cache,mode=max
      --cache-from=type=registry,ref=${CI_REGISTRY_IMAGE}/${PROJECT_NAME}:cache
      --tag ${DOCKER_REPOSITORY}/${PROJECT_NAME}:${DOCKER_TAG}
      ${DOCKER_BUILD_FLAGS} --file "${DOCKERFILE}" ${CONTEXT}
    - >
      docker buildx build ${PUSH}
      --cache-to=type=registry,ref=${CI_REGISTRY_IMAGE}/${PROJECT_NAME}:cache,mode=max
      --cache-from=type=registry,ref=${CI_REGISTRY_IMAGE}/${PROJECT_NAME}:cache
      --tag ${DOCKER_REPOSITORY}/${PROJECT_NAME}:${DOCKER_TAG}
      ${DOCKER_BUILD_FLAGS} --file "${DOCKERFILE}" ${CONTEXT}

.docker-publish:
  stage: docker
  image: ${BUILDX_BASE_IMAGE}
  services:
    - docker:stable-dind
  tags:
    - light
  variables:
    REGISTRY: ${CI_REGISTRY}
    REGISTRY_USERNAME: ${CI_REGISTRY_USER}
    REGISTRY_PASSWORD: ${CI_JOB_TOKEN}
    DOCKER_REPOSITORY: ${CI_REGISTRY_IMAGE}
    DOCKER_TAG: ${DOCKER_DEV_TAG}
    DOCKERFILE: "Dockerfile"
    CONTEXT: "."
    DOCKER_BUILD_FLAGS:
    PUSH: --push
  retry:
    max: 2
    when:
      - script_failure
  before_script:
    - rm -rf extra.sh
    - docker buildx inspect
    - docker buildx create --name deltafi-inator --use
    - docker buildx inspect
    - docker login -u ${REGISTRY_USERNAME} -p ${REGISTRY_PASSWORD} ${REGISTRY}
    - docker login -u ${CI_REGISTRY_USER} -p ${CI_JOB_TOKEN} ${CI_REGISTRY}
  script:
    - >
      echo docker buildx build ${PUSH} --platform ${DOCKER_PLATFORMS}
      --cache-to=type=registry,ref=${CI_REGISTRY_IMAGE}/${PROJECT_NAME}:cache,mode=max
      --cache-from=type=registry,ref=${CI_REGISTRY_IMAGE}/${PROJECT_NAME}:cache
      --tag ${DOCKER_REPOSITORY}/${PROJECT_NAME}:${DOCKER_TAG}
      ${DOCKER_BUILD_FLAGS} --file "${DOCKERFILE}" ${CONTEXT}
    - ls -la "$CONTEXT"
    - echo "$DOCKERFILE"
    - cat "$DOCKERFILE"
    - >
      docker buildx build ${PUSH} --platform ${DOCKER_PLATFORMS}
      --cache-to=type=registry,ref=${DOCKER_REPOSITORY}/${PROJECT_NAME}:cache,mode=max
      --cache-from=type=registry,ref=${DOCKER_REPOSITORY}/${PROJECT_NAME}:cache
      --tag ${DOCKER_REPOSITORY}/${PROJECT_NAME}:${DOCKER_TAG}
      ${DOCKER_BUILD_FLAGS} --file "${DOCKERFILE}" ${CONTEXT}

.docker-publish-gitlab:
  extends:
    - .docker-publish
  variables:
    REGISTRY: ${CI_REGISTRY}
    REGISTRY_USERNAME: ${CI_REGISTRY_USER}
    REGISTRY_PASSWORD: ${CI_JOB_TOKEN}
    DOCKER_REPOSITORY: ${CI_REGISTRY_IMAGE}
    DOCKER_TAG: ${CI_COMMIT_TAG}

.docker-publish-dockerhub:
  extends:
    - .docker-publish
  variables:
    REGISTRY: docker.io
    REGISTRY_USERNAME: ${DOCKERHUB_USERNAME}
    REGISTRY_PASSWORD: ${DOCKERHUB_PASSWORD}
    DOCKER_REPOSITORY: ${DOCKER_IO_NAMESPACE}
    DOCKER_TAG: ${CI_COMMIT_TAG}

.docker-multiarch:
  extends:
    - .docker-publish-dockerhub
  stage: docker
  tags:
    - heavy
  needs:
    - job: "Core Build"
  variables:
    CONTEXT: "${CI_PROJECT_DIR}/${PROJECT_NAME}/build/docker"
    DOCKERFILE: "${CONTEXT}/Dockerfile"
  rules:
    - if: $CI_COMMIT_TAG && $CI_PROJECT_NAMESPACE == 'deltafi'
    - if: $CI_COMMIT_TAG && $CI_PROJECT_NAMESPACE != 'deltafi'
      variables:
        PUSH: ""

.docker:
  extends:
    - .docker-build
  needs:
    - job: "Core Build"
  variables:
    CONTEXT: "${CI_PROJECT_DIR}/${PROJECT_NAME}/build/docker"
    DOCKERFILE: ${CONTEXT}/Dockerfile
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_COMMIT_BRANCH

.publish-python:
  extends:
    - .publish
  variables:
    GITLAB_PYPI_URL: "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/pypi"
  script:
    - ./gradlew $PROJECT_NAME:build
    - cd $PROJECT_NAME/src
    - uv publish --publish-url ${GITLAB_PYPI_URL} --username gitlab-ci-token --password ${CI_JOB_TOKEN}

.publish-python-pypi:
  extends:
    - .publish
  script:
    - ./gradlew $PROJECT_NAME:build
    - cd $PROJECT_NAME/src
    - uv publish --username __token__ --password ${PYTHON_PYPI_PUBLISH_PASSWORD}

.container_scanning:
  tags:
    - light
  variables:
    CS_ANALYZER_IMAGE: "$CI_TEMPLATE_REGISTRY_HOST/security-products/container-scanning:5"
    GIT_STRATEGY: fetch
  image: "$CS_ANALYZER_IMAGE$CS_IMAGE_SUFFIX"
  stage: scan
  allow_failure: true
  artifacts:
    reports:
      container_scanning: deltafi-core.container-report.json
    paths:
      - deltafi-core.container-report.json
      - deltafi-core-actions.container-report.json
      - deltafi-egress-sink.container-report.json
      - deltafi-nodemonitor.container-report.json
  dependencies: []
  when: manual
  rules:
    - if: $CI_COMMIT_TAG
      variables:
        IMAGE_TAG: $CI_COMMIT_TAG
        REGISTRY: docker.io/deltafi
    - if: $CI_COMMIT_BRANCH
      variables:
        IMAGE_TAG: $CI_COMMIT_SHORT_SHA
        REGISTRY: $CI_REGISTRY_IMAGE
  script:
    - which grype && grype db update
    - CS_DOCKERFILE_PATH=deltafi-core CS_IMAGE=${REGISTRY}/deltafi-core:${IMAGE_TAG} gtcs scan
    - cp gl-container-scanning-report.json deltafi-core.container-report.json
    - CS_DOCKERFILE_PATH=deltafi-core-actions CS_IMAGE=${REGISTRY}/deltafi-core-actions:${IMAGE_TAG} gtcs scan
    - cp gl-container-scanning-report.json deltafi-core-actions.container-report.json
    - CS_DOCKERFILE_PATH=deltafi-egress-sink CS_IMAGE=${REGISTRY}/deltafi-egress-sink:${IMAGE_TAG} gtcs scan
    - cp gl-container-scanning-report.json deltafi-egress-sink.container-report.json
    - CS_DOCKERFILE_PATH=deltafi-nodemonitor CS_IMAGE=${REGISTRY}/deltafi-nodemonitor:${IMAGE_TAG} gtcs scan
    - cp gl-container-scanning-report.json deltafi-nodemonitor.container-report.json

.distro-containers:
  stage: release
  tags:
    - light
  image: ${BUILDX_BASE_IMAGE}
  retry:
    max: 2
    when:
      - script_failure
  variables:
    REGISTRY: docker.io
    REGISTRY_USERNAME: ${DOCKERHUB_USERNAME}
    REGISTRY_PASSWORD: ${DOCKERHUB_PASSWORD}
    DOCKER_REPOSITORY: docker.io/deltafi
    DISTRO_PROJECT: deltafi
    ARCH: arm64
    OS: linux
    VERSION: ${CI_COMMIT_TAG}
  before_script:
    - docker buildx inspect
    - docker buildx create --name deltafi-inator --use
    - docker buildx inspect
    - docker login -u ${REGISTRY_USERNAME} -p ${REGISTRY_PASSWORD} ${REGISTRY}
  script:
    - export PLATFORM=linux/$ARCH
    - export TAG=$VERSION-$OS-$ARCH
    - echo docker buildx build --label version="$VERSION" --label org.opencontainers.image.version="$VERSION" --push --platform "$PLATFORM" -t "${DOCKER_REPOSITORY}/${DISTRO_PROJECT}:${TAG}" --build-arg VERSION="$VERSION" --build-arg OS="$OS" --build-arg ARCH="$ARCH" -f .ci/Dockerfile.dist ./.ci
    - docker buildx build --label version="$VERSION" --label org.opencontainers.image.version="$VERSION" --push --platform "$PLATFORM" -t "${DOCKER_REPOSITORY}/${DISTRO_PROJECT}:${TAG}" --build-arg VERSION="$VERSION" --build-arg OS="$OS" --build-arg ARCH="$ARCH" -f .ci/Dockerfile.dist ./.ci

