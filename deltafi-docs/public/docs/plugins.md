# Creating a Plugin

To create Actions and Flows for your organization, you need to start by creating a plugin.

Plugins are delivered in Helm Charts that launch pods running Actions.  Alongside the chart, plugins are registered with
a json file that is autogenerated based on Plugin settings in your build.gradle and Action annotations in your code.
Finally, one or more Flows can be shipped with each plugin to define how the Actions should be run.

A plugin project consists of a top-level project that defines the plugin properties
and one or more subprojects. Each subproject can have a group of Actions that will be
delivered together and run within the same k8s pod.

The overall structure looks like this:

```
actions-subproject-1/
actions-subproject-2/
charts/
flows/
build.gradle
gradle.properties
settings.gradle
```

## Gradle Files

Start with a `settings.gradle`, where we'll set up your root project name and tell gradle to build the subprojects.
```groovy
rootProject.name='my-plugin-project-name'

include 'actions-subproject-1'
include 'actions-subproject-2'
```

Next we'll use the `gradle.properties` to store a few variables. Set deltafiVersion to your target action-kit version.

```groovy
deltafiVersion=0.97.0
localDockerRegistry='localhost:5000'
palantirDockerVersion=0.22.1
```

Finally, you need some special setup in your `build.gradle` to create the plugin.

```groovy
plugins {
  id 'org.deltafi.plugin' version "${deltafiVersion}"
}

deltafiPlugin {
    displayName = 'My first plugin'
    description = 'Example project to demonstrate building a plugin'
    actionKitVersion = "${deltafiVersion}"
    // Dependencies on other plugins may be specified as follows:
    //   dependencies = [{ group = "a"; artifact = "b"; version = "c" }, { group = "d"; artifact = "e"; version = "f" }]
    dependencies = []
}
```

## Action Subprojects

Each action subproject needs some scaffolding of its own.

```
actions-subproject-1/src/
actions-subproject-1/build.gradle
actions-subproject-1/Dockerfile
```

The `src` directory is where your Actions will be developed using normal Java conventions
(main/src, main/resources, test/src, test/resources, etc).

The `build.gradle` needs to set up Docker packaging and some DeltaFi framework dependencies.

```groovy
plugins {
	id 'com.palantir.docker' version "${palantirDockerVersion}"
}

dependencies {
    annotationProcessor 'com.fasterxml.jackson.core:jackson-databind:2.13.3'
    annotationProcessor "org.deltafi:deltafi-action-kit:${deltafiVersion}"
    annotationProcessor "org.deltafi:deltafi-common:${deltafiVersion}"

    implementation "org.deltafi:deltafi-common:${deltafiVersion}"
    implementation "org.deltafi:deltafi-action-kit:${deltafiVersion}"
}

docker {
    dependsOn assemble
    tag "local", "${localDockerRegistry}/${project.name}:latest"
    name "${project.name}:${project.version}"
    copySpec.from('build/libs').into('build/libs')
    configurations.runtimeClasspath.each {copySpec.from(it).into('build/libs') }
}
```

Finally, create your `Dockerfile` with this boilerplate. We hope to automate this step soon.

```dockerfile
FROM deltafi/deltafi-action-base:0.96.0

COPY --chown=1001 build/libs/*.jar /deployments/plugins/
```

## Helm Charts

Your plugin will be deployed to a k8s cluster via Helm. The `charts` directory needs this basic setup:

```
charts/Chart.yaml
charts/values.yaml
charts/templates/deployment-subproject-1-actions.yaml
charts/templates/deployment-subproject-2-actions.yaml
```

The `Chart.yaml` is a description of your plugin for Helm.

```yaml
apiVersion: v2
name: my-plugin
version: 0.96.1
description: Helm chart to deploy my-plugin
appVersion: 0.96.1
```

`values.yaml` contains the location of each docker image that is deployed for your plugin as well as some *magic*
action_runtime items that must be present. This should all be automatically built in a future release.

```yaml
deltafi:
  subproject_1_actions:
    image: deltafi/subproject-1-actions:0.96.1
  subproject_2_actions:
    image: deltafi/subproject-2-actions:0.96.1
  action_runtime:
    image: deltafi/deltafi-action-runtime:0.96.1
    imagePullSecret: docker-secret
    envVars:
      - name: ACTIONS_HOSTNAME
        valueFrom:
          fieldRef:
            fieldPath: spec.nodeName
      - name: REDIS_PASSWORD
        valueFrom:
          secretKeyRef:
            name: redis-password
            key: redis-password
      - name: MINIO_ACCESSKEY
        valueFrom:
          secretKeyRef:
            name: minio-keys
            key: accesskey
      - name: MINIO_SECRETKEY
        valueFrom:
          secretKeyRef:
            name: minio-keys
            key: secretkey
```

Each of your subprojects must contain a template that instructs k8s how to start the pod containing the action runtime
as well as your linked action container. In the future, this should be autogenerated by the plugin.  For now, your
template should not deviate too far from this:

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: subproject-1-actions
  labels:
    app: subproject-1-actions
    group: deltafi-plugins
spec:
  revisionHistoryLimit: 0
  selector:
    matchLabels:
      app: subproject-1-actions
      group: deltafi-plugins
  template:
    metadata:
      labels:
        app: subproject-1-actions
        group: deltafi-plugins
    spec:
      containers:
      - name: subproject-1-actions
        image: {{ .Values.deltafi.subproject_1_actions.image }}
        lifecycle:
          postStart:
            exec:
              command: [ "/copy_plugins.sh" ]
        volumeMounts:
          - mountPath: "/plugins"
            name: plugins
      - name: deltafi-action-runtime
        image: {{ .Values.deltafi.action_runtime.image }}
        {{- with .Values.deltafi.action_runtime.envVars }}
        env:
        {{- toYaml . | nindent 8 }}
        {{- end }}
        volumeMounts:
          - mountPath: "/plugins"
            name: plugins
      volumes:
      - name: plugins
        emptyDir: {}
      imagePullSecrets:
      - name: docker-secret
```

A couple of *magic* files will appear whenever you build your project!

```
charts/files/plugin.json
charts/templates/job-register-plugin.yaml
```

It is important that you commit these to your repo whenever they change as they are needed for a clean helm install of
your plugin. We realize this is hokey and plan to rectify it soon.

## Flows

The `/flows` folder contains the flow json files that should be loaded with your plugin. See [Creating Flows](/flows)
for more details.