## [2.0-rc22] - 2024-11-07

### Highlights
- PostgreSQL migration
  - PostgreSQL has replaced MongoDB for all configuration and DeltaFile retention
  - Postgres CLI integrated in the DeltaFi CLI
- DeltaFi API v1 has been replaced with DeltaFi API v2.
  - The separate `deltafi-api` container is no longer necessary
  - API has been reimplemented in Java
- Full support for Kubernetes and compose orchestration for all 2.0 features
- Flows have been rearchitected for 2.0, including new concepts, a pub-sub architecture, and streamlined action and flow design
- Full support for Kubernetes, KinD, and Compose container orchestration

### Added
- [core-actions] Add simple XML editing/grooming core action (GitLab-211)
- [deltafi-python] Add support to specify empty input and output contents in test kit (#266)
- [deltafi-python] Add documentation and tests for serialization of complex data types in action parameter classes (GitLab-299)
- Added Helper buttons calender refresh to Events page
- Flow Builder joins use supportsJoin logic
- Added the ability to update the Cron schedule inline for datasource.
- Added the ability to bulk cancel DeltaFiles from the Search page.
- New DeleteContent action
- Added maxFlowDepth system property to prevent circular flows
- Added a @Size annotation that will generate minLength and maxLength constraints for action parameters
- Added Markdown documentation for all core transform actions.
- Added Annotate core action (org.deltafi.core.action.annotate.Annotate)
- Integration test CLI, GraphQL endpoints, service, and repo
- Nodemonitor will automatically create application metrics when docker is available.  This will
  allow application metrics in the compose configuration when clustermonitor is not available.
- Python test kit: Added support for action collect mode
- Added Test Mode toggle switch to Egress page.
- Flow Plan Builder now hides and clears the topic field for the default publish rule unless the defaultBehavior is "Publish"
- Added CLI commands `load-integration-test` and `run-integration-test`
- Decompress now supports 7z compression/archive format
- Added a default disk space delete policy that deletes at 80%
- Integration tests are now automatically loaded as part of the plugin registration process. Supported formats are JSON and YAML for Java plugins, and JSON for Python plugins
- Add join field descriptions to the action configuration dialog
- Add `deltafi postgres-cli` implementation in compose
- Added parameters to content-selecting actions that allow selection by exclusion.
- Add index to delta_file_id on delta_file_flows. Was previously only present in a compound index.
- Plugins may now include documentation for their actions by including Markdown files in the docs directory. They may be
viewed by selecting the help icon next to the action name on the Flow Plan Builder.
  - Java:  Include Markdown files with full class names and a ".md" suffix in src/main/resources/docs
  - Python: Include Markdown files with class names and a ".md" suffix in  src/{plugin-dir}/docs
- Added the option to create configuration files for an entity resolver through the `values.yaml` in both kubernetes and compose.
- Add a first pass delete when metadata is being deleted to remove any metadata that does not have associated content (because it was already deleted by another delete policy)
- Added "New Transform" link on Transforms page
- TimescaleDB added to all orchestration systems
- Clickhouse analytic event tables replaced with TimescaleDB/PostgreSQL analytic event tables
- Grafana: PostgreSQL data source added
- Grafana: New dashboards created for annotation and error analytics
- Kubernetes orchestration - added local-path-provisioner scripts to support Postgres storage
- Added a new command, `deltafi configure-plugin-ssl`, for setting up keys and certs for plugins
- Add documentation for configuring SSL in plugins
- Add check for default topic when default publish behavior is PUBLISH
- Added Transforms filter to DeltaFile Search page
- Add a top-level array of unique content object ids that belong to each deltafile to improve delete performance
- Add graphql endpoints for querying topics
- Added Topics page to web UI
- Metrics: Added transform flow level bytes/files in/out metrics
- Added the option to define flow plans in yaml in Java plugins
- Add topics filter

### Changed
- Increase default number of threads for Rest and FlowFile post egress actions to 4
- Configure the MinioClient with an HttpClient with a connection pool
- Auto Resume remove confirmation should show Name instead of Id
- Sorted Actions and Variables tables in plugins page (315).
- Set system property 'pluginImageRepositoryBase' value for compose environments (#323)
- Clicking on an errored flow on the DeltaFile Viewer or Errors page now shows the error content dialog.
- Changed the Flow Plan Builder to display multi-line Textareas when an action parameter has a maxLength > 80
- Update the monitor k8s resource check to only execute when it is running in a cluster
- Content saved by an action which returns an Error or Filter Result will be deleted by core upon receipt of the associated Action Event
- Core actions changed:
  - org.deltafi.core.action.ingress.SftpTimedIngressAction -> org.deltafi.core.action.ingress.SftpIngress
  - org.deltafi.core.action.merge.MergeContentFormatAction ->
    - org.deltafi.core.action.compress.Compress (.ar, .tar, .tar.gz, .tar.xz, or .zip)
    - org.deltafi.core.action.merge.Merge (binary concatenation)
  - org.deltafi.core.action.CompressionFormatAction -> org.deltafi.core.action.compress.Compress
  - org.deltafi.core.action.ConvertContentTransformAction -> org.deltafi.core.action.convert.Convert
  - org.deltafi.core.action.DecompressionTransformAction -> org.deltafi.core.action.compress.Decompress
    - Added `retainExistingContent` parameter
  - org.deltafi.core.action.DeleteMetadataTransformAction -> org.deltafi.core.action.metadata.ModifyMetadata
  - org.deltafi.core.action.DeltaFiEgressAction -> org.deltafi.core.action.egress.DeltaFiEgress
  - org.deltafi.core.action.DetectMediaTypeTransformAction -> org.deltafi.core.action.mediatype.ModifyMediaType
    - With `autodetect` parameter set to `true` (default)
  - org.deltafi.core.action.ErrorByFiatTransformAction -> org.deltafi.core.action.error.Error
  - org.deltafi.core.action.ExtractJsonMetadataTransformAction -> org.deltafi.core.action.extract.ExtractJson
    - With `extractTarget` parameter set to `METADATA` (default)
  - org.deltafi.core.action.ExtractXmlAnnotationsDomainAction -> org.deltafi.core.action.extract.ExtractXml
    - With `extractTarget` parameter set to `ANNOTATIONS`
  - org.deltafi.core.action.ExtractXmlMetadataTransformAction -> org.deltafi.core.action.extract.ExtractXml
    - With `extractTarget` parameter set to `METADATA` (default)
  - org.deltafi.core.action.FilterByCriteriaTransformAction -> org.deltafi.core.action.filter.Filter
  - org.deltafi.core.action.FilterByFiatTransformAction -> org.deltafi.core.action.filter.Filter
  - org.deltafi.core.action.FilterEgressAction -> org.deltafi.core.action.egress.FilterEgress
  - org.deltafi.core.action.FlowfileEgressAction -> org.deltafi.core.action.egress.FlowfileEgress
  - org.deltafi.core.action.JoltTransformAction -> org.deltafi.core.action.jolt.JoltTransform
  - org.deltafi.core.action.LineSplitterTransformAction -> removed
  - org.deltafi.core.action.MetadataToAnnotationTransformAction -> org.deltafi.core.action.annotate.Annotate
  - org.deltafi.core.action.MetadataToContentTransformAction -> org.deltafi.core.action.metadata.MetadataToContent
    - Replaced `replaceExistingContent` with `retainExistingContent`. Value must be inverted!
  - org.deltafi.core.action.ModifyMediaTypeTransformAction -> org.deltafi.core.action.mediatype.ModifyMediaType
  - org.deltafi.core.action.ModifyMetadataTransformAction -> org.deltafi.core.action.metadata.ModifyMetadata
  - org.deltafi.core.action.RecursiveDecompress -> org.deltafi.core.action.compress.RecursiveDecompress
  - org.deltafi.core.action.RestPostEgressAction -> org.deltafi.core.action.egress.RestPostEgress
  - org.deltafi.core.action.RouteByCriteriaTransformAction -> removed
  - org.deltafi.core.action.SmokeTestIngressAction -> org.deltafi.core.action.ingress.SmokeTestIngress
  - org.deltafi.core.action.SplitterLoadAction -> org.deltafi.core.action.split.Split
  - org.deltafi.core.action.XsltTransformAction -> org.deltafi.core.action.xslt.XsltTransform
- Allow blank values in `deltafi system-property set` command
- Allow blank values in the `pluginImageRepositoryBase` property
- Grafana is now accessible via `/visualization`
- Embedded charts in the UI now use `/visualization` instead of subdomain
- Integration test:
  - changed expected delta files to a list
  - changed expectedActions to expectedFlows, and added default state DeltaFileFlowState.COMPLETE
  - require each test configuration have a description, which is now added to TestResult
- Modified the python action kit to track saved content by actions so that it can be deleted by core if the action returns an error or filter result
- Core actions that expect XML media types now accept `application/xml` and `text/xml` by default (using `*/xml` wildcard)
- Upload page trims trailing whitespace from metadata key/value fields
- Headers in the Publish/Subscribe section of the Flow Plan Builder are now capitalized with spaces instead of camelCase.
- Dropdown options in the Publish/Subscribe section of the Flow Plan Builder are now normalized.
- Integration tests are now stored separately from their results with new GraphQL endpoints. This allows for test configurations to be saved once, and run later by using just the name
- Role `IntegrationTestLaunch` renamed to `IntegrationTestUpdate`
- Changed the way the Pub/Sub sections appeared and the functionality within them
- UI: Split the image reference in the plugin install/upgrade dialog into separate fields for image name and tag.
- Store the plugin image name and image tag in separate fields
- Updated Decompress action to support batch content saves to MINIO for the 7z format
- Creating a user with the DN set or updating a user DN will always update the username to the CN
- The `Admin` permission will always be added back to the `Admin` user on restart if it was removed
- Changelog tool will auto git-add when creating or editing the changelog
- Added data source specific CLI commands `timed-data-source` and `rest-data-source`
- Compose: Service port changed to localhost:8042 from 8888
- The monitor checks now run in `deltafi-core`
- Auth requests are sent the `deltafi-core-service`
- Custom entity resolvers are run in the `deltafi-core` and `deltafi-core-worker` pods
- Update the deltaFiles created index to include the dataSource column
- Updated all copyright dates on source headers
- Added additional layer to core UI build in dockerfile to optimize rebuild performance
- Made deltafi-core host the UI and docs
- Add goroutine workers to the egress sink
- Replaced the entity resolver PVC mount with a ConfigMap mount
- DeltaFileStats endpoint sends an exact count of total DeltaFiles if the estimate is < 100k, else it uses the estimate
- Improve query performance by allowing batch fetches
- No longer guarantee order deltaFiles are deleted in.  Previously the removals were sorted by modified date, now deletes will happen in random order, to improve performance.
- [deltafi-core] Update generated plugin's gitlab-ci.yml template
- Look for a header of `DataSource` instead of flow in the ingress endpoint
- Updated field labels and placeholders on New Data Sink dialog
- Updated edit tooltip on Transform Builder page
- KinD: `cluster manifest` changed to `cluster images` to line up with docker and compose commands
- Only schedule the `handleTimedOutJoins` task to run when `schedule.maintenance` is true
- Schedule `handleTimedOutJoins` to run at a fixed delay of one second instead recalculating the next scheduled time
- Reject join configurations with a maxAge below one second
- Moved integration test-related GraphQL types from core to common
- Moved DeltaFileFlowState from core to common
- The Decompress action now supports recursive decompression, with lineage map history/parser
- Unused ("orphaned") content is now handled within the execution of the action that made it rather than in core. Logic
  has been generalized to account for all action event types.
- All orchestration related files have been moved to `/orchestration`
- Install plugins using the full docker image instead of plugin coordinates
- Increased Postgres max connections to 1000 for Kubernetes and compose deployments
- Set the default logging level in the python action kit to INFO (was DEBUG)
- Rename core to core-scheduler
- Rename egress flows to data sinks
- Rename flows to transforms
- On joined files, change data source from "multiple" to "joined:<flowName>"
- Renamed Egress Flows to Data Sinks on DeltaFile Search page
- Content viewer now defaults to showing formatted content when possible
- Increase core hikari postgres maximum pool size to 32
- Increase default startup probe to 3 second checks for 5 minutes (up from 90 seconds)
- Changed startup probe duration for core-scheduler to keep trying for up to 7 hours to accommodate migrations
- Remove survey audit logging
- Create the child DeltaFile `did` from the action kits so the child `did` can be used within the child result
- Metrics: Redesigned and retagged ingress and egress bytes/files metrics
- Convert postgresql varchar fields to text

### Fixed
- DeltaFi CLI
  - Fix pub/sub fields in `export-egress-plan` and `export-transform-plan`
  - Updated help/usage to match current command set
- [deltafi-python] Fix test_kit to bypass input/output file reads if empty string content given (#266)
- Fixed errors displayed when installing a plugin on the Plugins page
- Trim groupId, artifactId, and version on Plugins page
- Sorted plugin list in "Select a Plugin" dropdown on Flows page
- Added HTML 'pre' tag to json list renderer to preserve string formatting from backend when displaying descriptions
- Fixed default boolean and integer values not being set in Actions in Flow Builder
- Fixed row height issue with remove button.
- [deltafi-core-actions] Set default parameters in core actions (#284)
- Fixed the Flow Plan Builder Subscribe and Publish sections to allow for saving.
- Fixed bug in Additional Properties Renderer where "[object Object]" appears when a new property is added.
- [deltafi-python] Fix deprecation warning concerning datetime (#296)
- Search Page Calendar Helper now base times off of current time not the time when the calendar dialog was opened.
- Search Page Calendar now shows the time being used every time the dialog is reopened instead of whatever values it was previously closed with.
- Fixed header spacing of buttons and drop downs on several of the pages.
- [deltafi-python] Fix python 3.12 thread compatibility that was affecting the MinIO client (GitLab-300)
- Values selected in the dropdowns in the JSON Renderers can now be cleared out
- Fixed issue in search page calendar looking for data not available on prod builds
- Arrays of integers are no longer being removed from flows on save.
- Added join logic to all actions.
- Added primevue dropdown package to flows page.
- Added DataKey to all DataTables
- Decompress action now batches "save many contents" to MINIO
- Updated deltafile/ingress and deltafi/annotate endpoint to new api/v2 path in docs
- [deltafi-common] Fix order of arguments in ActionContext 'copy' method
- Fixed the CORE_URL when running a plugin locally with `cluster plugin run`
- Removed `property-set` flag in the system-property command (the field is no longer part of the `updateProperties` mutation)
- Fix a bug where updating a system plugin data source would use previous topics and cron schedules instead of the new values
- Fixed the "double authentication" issue when using basic auth
- Lock down Python dependency versions to match what is in the deltafi python base image
- Fix race condition where multiple core/workers could pick up actions from a new DeltaFile and have alternate versions of the truth cached
- In the python action kit, the DID for timed-ingress content saved should match the `IngressResultItem` DID
- Annotation service was incorrectly searching transform flows when restoring expected annotations from a system snapshot
- Fixed potential bug related to default SSL ciphers used in Kubernetes ingress.
- Fixed issue where cloned flows actions override original actions data and cant be removed in the Flow Builder.
- You can now view/search all actions on Flow Plan Builder no matter the number of actions
- Fixed bug with Create Auto Resume Rule on DeltaFile Viewer.
- When ContentResult was created with a content list in the constructor parameters, later attempt to save additional content would throw an immutable list exception
- Updated the scheduled join query to only update unlocked join entries to prevent multiple workers from acting on the same JoinEntry
- Fixed bug of minNum and maxNum not able to be equal.
- Fixed bug of minNum being able to equal to 0.
- Fixed issue where you couldn't save a edited Transform flow in the builder when the edit involves removing an entire action
- Allow unknown users to be resolved by the entity resolver instead of automatically denying access
- Fixed a bug where the java based actions attempted to read all files in the flows directory instead filtering by the extension
- Topics list now properly updates when navigating between pages
- fix minor formatting issue in action runner logs
- CI: `ci` branch creation post orchestration reorganization
- Fix issue where the error message was not rolled up to the flow when adding a circular flow errored action
- Bug in CLI where quoted string arguments would be tokenized by spaces
- Fixed issue with cluster plugin builds not using cluster.yaml
- Warning in clustermonitor Dockerfile fixed
- Compose: MinIO container name fix
- Use the valkey replication mode of primary, master is no longer supported
- Filter DeltaFiles that come through a DataSource with test mode enabled
- Updated documentation for the Decompresss action to reflect new recursive parameters
- Fix: deleting by timed delete policy when content is not present should respect batch limits
- Turn off cache-control response headers from auth
- Fix filtering by flow type on errors page
- Fix search by error cause on the errors page
- Fixed a path in the Decompress action that might not use the correct content name for a decompress
- Fix queries for autoresume and cold queuing that were not properly fetching the entire deltaFile
- Error DeltaFiles when next action configuration is not found for the next pending action to prevent getting stuck in flight
- [deltafi-core] Fix bug in Java plugin generation due to re-name and re-package of RestPostEgress
- Fix type definition bug in 'plugin-init' command
- Fix requeue
- Bug fixed where DeltaFile with version 0 could not be resumed
- When rebuilding flows only carry the running flow state forward to prevent getting flows stuck with an invalid state
- Prevent duplicate plugins by adjusting database primary key
- Fixed rendering issue with New Data Sink dialog on Data Sinks page
- Fixed the query used to update the system plugin version in flows
- Fixed the query used to search for running flows by plugin coordinates
- Reset test mode and max errors on flows when running a hard snapshot reset
- Fix the query used to find flows by name and type
- Add flyway baseline parameters to migrate existing schema on upgrade
- KinD: Missing `_is_arm()` function restored
- Fix a bug where the wrong JoinEntry can be returned resulting in a duplicate key exception
- Support optional maxNum join settings in the StateMachine
- MaxErrors should be aggregated by data source names, not flow names
- Populate ancestor flow numbers
- Fix issue where revalidation of plugin currently being registered could cause a rollback exception preventing registration
- Add default timestamp to analytic event
- Immediately update a DeltaFile's status in the database when it is resumed. This fixes cases where it would not show up as resumed while actions were still being performed and cached locally.
- Fixed bug preventing snapshots from being imported
- Track DeltaFiles that fail to update during timed join processing and retry them later to prevent them from becoming stuck in flight
- Fix dataSource sorting and other camelCase fields when using the graphQL deltaFiles endpoint's orderBy 

### Removed
- MongoDB removed, replaced with PostgreSQL
- DeltaFi API v1 is no longer available
- Removed deprecated survey rest endpoint
- Removed deprecated survey Grafana dashboard
- Python test kit: Removed old action types, Domain, Enrich, and Validate
- Removed CLI command `integration-test`
- Removed `data-source` command
- Removed the standalone `deltafi-auth` and `deltafi-monitor` deployments
- Removed deltafi-ui and deltafi-docs containers
- Removed Transform Builder from sidebar menu
- Clickhouse removed for all orchestration systems
- Grafana: Clickhouse diagnostic dashboards removed
- Grafana: Clickhouse analytics removed
- Removed `deltafi.ssl.*` fields from the `values.yaml` leaving just the secret field. Core and plugins are now setup to look for key and cert files in a fixed location (/certs)
- Removed the plugin image repository related code
- Remove ingress and delete audit logging
- Remove unused flow plan coordinates from DeltaFileFlow
- Remove destination from EgressResult. Metrics are already associated with the egress.
- Remove separate ingress deployment, have core workers handle ingress and immediately affinitize and cache DeltaFiles
- Remove option to turn off the DeltaFileCache
- Metrics: Action level byte and file counts removed
- Removed vestigial deltafi-auth code from the core codebase

### Security
- Made SSL ciphers configurable

### Tech-Debt/Refactor
- Replaced deprecated CountingInputStream with BoundedInputStream in all usages
- Moved building ActionDescriptor from Action to PluginRegistrar
- Removed contentStorageService from Action
- Moved authentication from the standalone `deltafi-auth` project into `deltafi-core`
- Improve the locking mechanism for the DidMutexService. Use a global ReentrantLock instead of relying on a local synchronized method.
- Identify flow referenced by action event by id only, not id and name
- Ensure DeltaFiles are fetched in a single database transaction.
- Add flyway migration baseline
- Store actions as jsonb in the deltaFile flows table
- Only run the JoinEntryLockCheckScheduler on the core with schedule.maintenance set
- Optimize ErrorCountService
- Remove deprecated noverify startup flag from core
- Improve auto-resume performance
- Use pem files for setting up SSLContexts instead of JKS or p12 formats
- Made all fields in ActionParameter subclasses private
- Remove the flowPlans postgres table. Begin simplifying plugin code.
- Relocated core.exception classes to deltafi-core source tree (InvalidActionEventException UnexpectedActionException UnexpectedFlowException)
- Remove explicit transaction management from insertOne, as it is already handled by the @Transactional annotation
- Remove redundant @Index annotations, since these are now handled by Flyway
- Speed up single DeltaFile inserts
- Remove unused normalizedName field from DeltaFile
- remove unused action event queue methods
- Tweak parameters to silence startup warnings and speed up startup
- Standardize action parameter class annotations
- Optimize subscriber lookups
- Do not reload entire flow cache on timed data source state changes
- Remove unused graphql fields
- improve requeue query performance
- improve data source created before delete policy performance
- remove temp table when marking content deleted
- Clean up warnings and dead code paths throughout the codebase
- Change delta_files and delta_file_flows postgres jsonb columns to arrays where possible  
- Improve performance of transforms and dataSinks filters 

### Upgrade and Migration
- Updated Java dependencies
  - nifi-flowfile-packager 1.27.0
  - bcpkix-jdk18on 1.78.1
  - json-schema-validator 1.5.2
  - commons-text 1.12.0
  - dropwizard 4.2.28
  - kubernetes-client 6.13.4
  - docker-java 3.4.0
  - postgresql 42.7.4
  - hypersistence-utils-hibernate-63 3.8.3
  - flyway 10.20.0
  - nifi 1.27.0
  - dgsCodegen 6.3.0
  - dgs 9.1.3
  - jackson 2.17.2
  - json schema generator 4.36.0
  - minio 8.5.12
  - spring boot 3.3.4
- New `Integration Tests` permissions/roles: IntegrationTestLaunch, IntegrationTestView, IntegrationTestDelete
- Upgraded python base image to 3.12.4-0
- Updated python dependencies versions for: minio, pydantic, pytest, redis, requests, and urllib3
- Added Python 3.12 to the CI deltafi-build image
- Python module deepdiff now requires installation of numpy
- New table `integration_tests` and column name change in `test_results`
- Integration test YAML now requires `name` field
- Update clustermonitor kubectl to latest version (1.31.2)
- This clears the DeltaFiles, DeltaFileFlows, and Annotation tables. Minio data should be manually deleted.
- Upgrade KinD to 1.31.0
- Plugins must be recompiled with the latest action kit
- KinD: due to orchestration file relocation, execution of `orchestration/kind/install.sh` will be
  necessary to re-configure tooling
- TransformResults now collect a new type, `ChildTransformResult`, in both java and python instead of collecting objects of type TransformResult. 
Java Sample:
```java
TransformResults manyResults = new TransformResults(context);
ChildTransformResult result = new ChildTransformResult(context, name);
manyResults.add(result);
```
Python Sample:
```python
transform_many_result = TransformResults(context)
child = ChildTransformResult(context, name)
transform_many_result.add_result(child)
- Upgraded GraphiQL UI to 3.4.0
- Upgrade to Valkey 8.0.1
- Upgrade to Java 21.0.5
- Updated python packages to match deltafi/python:3.12.7-0 image:
    - minio: 7.2.10
    - PyYAML: 6.0.2 (new)
    - pydantic: 2.9.2
    - redis: 5.2.0
    - urllib3: 2.2.3
    - pytest: 8.3.3

